<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÁÆóÊúØÁªÉ‰π†</title>
    <!-- <script src="dayjs.min.js"></script>
    <script src="duration.js"></script>
    <script src="vue.global.prod.js"></script>
    <script src="echarts.min.js"></script>
    <script src="arco-vue.min.js"></script>
    <script src="arco-vue-icon.min.js"></script>
    <link rel="stylesheet" href="arco.css" /> -->
    <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/duration.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/echarts@5.4.0/dist/echarts.min.js"></script>
    <script src="https://unpkg.com/@arco-design/web-vue@latest/dist/arco-vue.min.js"></script>
    <script src="https://unpkg.com/@arco-design/web-vue@latest/dist/arco-vue-icon.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@arco-design/web-vue@latest/dist/arco.css" />
    <style>
      body {
        font-size: 24px;
      }

      .page-header {
        padding: 20px;
      }

      .page-header h1 {
        font-size: 1.25em;
      }

      .question-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
      }

      .page-content {
        display: flex;
        flex-direction: column;
        font-size: 30px;
        padding-bottom: 1em;
      }

      .response {
        padding: 2em 0;
        font-size: 1em;
        font-weight: bold;
        vertical-align: middle;
        color: var(--color-neutral-6);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .page-content .arco-input-wrapper .arco-input.arco-input-size-large,
      .arco-btn {
        font-size: 30px;
      }

      .arco-btn {
        padding-top: 1em;
        padding-bottom: 1em;
      }

      .mla {
        margin-left: auto;
      }

      .histories-ol li {
        padding-right: 1em;
        margin-bottom: 0.5em;
      }

      .histories-ol .arco-col {
        text-align: center;
        font-size: 20px;
      }

      .histories-wrapper {
        padding: 0 1em;
      }

      .success {
        color: rgb(var(--green-6));
      }

      .error {
        color: rgb(var(--red-6));
      }

      .time,
      .time .arco-statistic-content .arco-statistic-value {
        color: var(--color-neutral-6);
        font-size: 16px;
        font-weight: normal;
      }

      .time {
        margin-bottom: 1em;
        justify-content: center;
      }

      .arco-input-number .arco-input {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <a-layout>
        <a-layout-header class="page-header">
          <h1 align="center">ÁÆóÊúØÁªÉ‰π†</h1>
          <a-space fill style="justify-content: flex-end">
            <a-checkbox-group v-model="operations" @change="next" size="large">
              <a-checkbox
                v-for="operator in OPERATORS"
                :key="operator"
                :value="operator"
                :disabled="isActiveAndOnly(operator)"
              >
                <template v-if="operator === '+'"><icon-plus /></template>
                <template v-else-if="operator === '-'"><icon-minus /></template>
                <template v-else-if="operator === '*'"><icon-close /></template>
                <template v-else>{{operator}}</template>
              </a-checkbox>
            </a-checkbox-group>
            <a-button
              @click="reset"
              size="large"
              :style="{
              fontSize: '14px',
            }"
            >
              ÈáçÁΩÆ
            </a-button>
          </a-space>
        </a-layout-header>
        <a-layout-content class="page-content">
          <a-space class="question-wrapper">
            <span>{{question.first}}</span>
            <template v-if="question.operator === '+'"><icon-plus /></template>
            <template v-else-if="question.operator === '-'"><icon-minus /></template>
            <template v-else-if="question.operator === '*'"><icon-close /></template>
            <template v-else>{{question.operator}}</template>
            <span>{{question.second}}</span>
            <span>=</span>
            <span>
              <a-input-number
                ref="input"
                v-model="question.answer"
                hide-button
                @input="val => question.answer = val"
                @clear="reAnswer"
                @keyup.enter="() => question.completed ? next() : answered ? judge() : void 0"
                style="width: 100px"
                size="large"
                pattern="[0-9]*"
                type="tel"
                :readonly="question.completed"
              />
            </span>
            <span v-if="question.showAnswer" style="color: rgb(var(--orange-6))">{{answer}}</span>
          </a-space>
          <a-space direction="vertical" fill>
            <template v-if="question.completed">
              <div
                class="response"
                :style="{
                  background: correct ? 'rgb(var(--green-1))' : 'rgb(var(--red-1))',
                  color: correct ? 'rgb(var(--green-6))' : 'rgb(var(--red-6))' 
                }"
              >
                {{response}}
              </div>
              <a-space class="time" fill>
                <span>Êú¨È¢òÁî®Êó∂</span>
                <a-statistic
                  :value="duration / 1000"
                  :precision="2"
                  animation
                  :animation-duration="500"
                ></a-statistic>
                <span>Áßí</span>
              </a-space>
              <a-button @click="next" size="large" long type="primary">‰∏ã‰∏ÄÈ¢ò</a-button>
            </template>
            <a-button type="primary" @click="judge" size="large" v-else :disabled="!answered" long>
              Êèê‰∫§
            </a-button>
            <template v-if="question.completed && !correct">
              <a-button status="success" @click="showAnswer" size="large" long>Êü•ÁúãÁ≠îÊ°à</a-button>
            </template>
          </a-space>
        </a-layout-content>
        <a-layout-footer class="histories-wrapper">
          <div style="font-size: 14px; margin-bottom: 8px">
            Â∑≤ÂÆåÊàê {{histories.length}} ÈÅìÈ¢òÁõÆ, ÂÖ∂‰∏≠Ê≠£Á°Æ {{ histories.filter(item => item.answer ===
            calc(item))?.length }} ÈÅìÈ¢ò, ÈîôËØØ {{histories.filter(item => item.answer !==
            calc(item))?.length }} ÈÅìÈ¢ò„ÄÇ
          </div>
          <div style="font-size: 14px">
            Áî®Êó∂ {{ totalTime.format('m ÂàÜ s Áßí') }}ÔºåÂπ≥ÂùáÊØèÈÅìÈ¢òÁî®Êó∂ {{average.format('s Áßí')}}
          </div>
          <ol class="histories-ol">
            <li v-for="(question, inde) in histories" :key="index">
              <a-row :gutter="2">
                <a-col :span="3">
                  <span>{{question.first}}</span>
                </a-col>
                <a-col :span="3">
                  <template v-if="question.operator === '+'"><icon-plus /></template>
                  <template v-else-if="question.operator === '-'"><icon-minus /></template>
                  <template v-else-if="question.operator === '*'"><icon-close /></template>
                  <template v-else>{{question.operator}}</template>
                </a-col>
                <a-col :span="3">
                  <span>{{question.second}}</span>
                </a-col>
                <a-col :span="2">
                  <span>=</span>
                </a-col>
                <a-col :span="4">
                  <span
                    :class="{
                  success: calc(question) === question.answer,
                  error: calc(question) !== question.answer
                }"
                  >
                    {{question.answer}}
                  </span>
                </a-col>
                <a-col :span="9">
                  <div style="text-align: right">
                    <span v-if="calc(question) === question.answer" class="success">
                      <icon-check-circle />
                    </span>
                    <span v-else class="error">
                      <icon-close-circle />
                    </span>
                  </div>
                </a-col>
              </a-row>
            </li>
          </ol>
          <a-back-top />
        </a-layout-footer>
      </a-layout>
    </div>
    <script type="text/javascript">
      const MAX = 20;
      const OPERATORS = ['+', '-', '*'];
      const RIGHT_RESPONSES = [
        'üòÄ Â§™Ê£í‰∫Ü',
        'üòç ÂÆåÁæé',
        'ü•≥ ‰Ω†Â•ΩÂéâÂÆ≥',
        'ü•∞ ‰Ω†ÊòØÊúÄÊ£íÁöÑ',
        'üêÑ Â§™Áâõ‰∫Ü',
        '‚úåüèª ÂÆåÂÖ®Ê≠£Á°Æ',
        'üíã Áà±‰Ω†Âì¶',
        'üëçüèª Â≠¶ÁöÑÁúüÂø´',
        'üòã ‰Ω†ÁúüËÅ™Êòé',
        '‚ò∫Ô∏è ‰Ω†ÁúüÁöÑÂæàËÉΩÂπ≤Âì¶',
        'üê∏ ‰Ω†ÁúüÊòØ‰∏™ËÅ™ÊòéÁöÑÂ≠©Â≠ê',
        'üå∫ ‰Ω†ÂÅöÁöÑÈùûÂ∏∏Â•Ω',
        'üåü ‰Ω†ÂÅöÂØπ‰∫Ü',
        'ü§© ËøõÊ≠•ÂæàÂ§ßÔºåÁªßÁª≠‰øùÊåÅ',
        'üòé Â∏ÖÂëÜ‰∫Ü',
        'üêÆüêÆüêÆüêÆüêÆ ÁâõÁâõÁâõÁâõÁâõ',
      ];
      const ERROR_RESPONSES = ['üòå ‰∏çÂØπ', 'üòì ÂÜçÊÉ≥‰∏ÄÊÉ≥', 'üò§ ÈîôËØØÔºåÁªßÁª≠Âä™Âäõ', 'üò± ËøòË¶ÅÂä†Ê≤π‰∫Ü'];

      function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      const { createApp, reactive, computed, onMounted, ref, watch, nextTick } = Vue;
      dayjs.extend(dayjs_plugin_duration);
      const sound = window.speechSynthesis;

      const storageHistories = (() => {
        const stored = localStorage.getItem('histories');
        try {
          return stored ? JSON.parse(stored) : [];
        } catch {
          return [];
        }
      })();

      const app = {
        setup() {
          const question = reactive({
            first: 0,
            second: 0,
            operator: OPERATORS[0],
            answer: undefined,
            completed: false,
            showAnswer: false,
            operatorSetting: 'random',
            begin: null,
            end: null,
          });
          const input = ref();
          const operations = ref([...OPERATORS]);

          const histories = reactive(storageHistories);

          const calc = question =>
            question.operator === OPERATORS[0]
              ? question.first + question.second
              : question.operator === OPERATORS[1]
              ? question.first - question.second
              : question.first * question.second;

          const answer = computed(() => calc(question));

          const answered = computed(() => question.answer !== undefined && question.answer !== '');

          const correct = computed(
            () => answered.value && answer.value === Number(question.answer)
          );

          const response = computed(() => {
            if (question.completed && answered.value) {
              const responses = correct.value ? RIGHT_RESPONSES : ERROR_RESPONSES;
              return responses[getRandomInt(0, responses.length - 1)];
            }
          });

          const reAnswer = async () => {
            question.answer = undefined;
            question.showAnswer = false;
            question.completed = false;
            question.begin = dayjs().valueOf();
            await nextTick();
            input.value.focus();
          };

          const setOperator = val => {
            question.operator = val;
          };

          const getQuestion = () => {
            question.operator =
              question.operatorSetting === 'random'
                ? operations.value[getRandomInt(0, operations.value.length - 1)]
                : question.operatorSetting;
            question.first =
              question.operator === OPERATORS[2] ? getRandomInt(1, 10) : getRandomInt(1, MAX);
            question.second =
              question.operator === OPERATORS[1]
                ? getRandomInt(0, question.first)
                : question.operator === OPERATORS[2]
                ? getRandomInt(0, 9) // ‰πòÊ≥ï‰øùËØÅ‰πòÊï∞ËåÉÂõ¥Âú® 0-9
                : getRandomInt(1, MAX);
          };

          const judge = () => {
            question.completed = true;
            question.end = dayjs().valueOf();
            histories.push({ ...question });
            localStorage.setItem('histories', JSON.stringify(histories));
          };

          const next = () => {
            reAnswer();
            getQuestion();
          };

          const showAnswer = () => {
            question.showAnswer = true;
          };

          const reset = () => {
            histories.length = 0;
            localStorage.clear('histories');
          };

          const getDuration = ({ begin, end }) => dayjs(end).diff(dayjs(begin), 'millisecond');

          const duration = computed(() => getDuration(question));

          const totalDuration = computed(() =>
            histories.reduce((prev, curr) => prev + dayjs(curr.end).diff(dayjs(curr.begin)), 0)
          );
          const totalTime = computed(() => dayjs.duration(totalDuration.value, 'millisecond'));

          const average = computed(() =>
            dayjs.duration(histories.length ? totalTime.value / histories.length : 0, 'millisecond')
          );

          const isActiveAndOnly = value =>
            operations.value.length <= 1 && operations.value.includes(value);

          onMounted(() => {
            next();
          });

          watch(
            () => question.completed,
            value => {
              if (value) {
                sound.speak(
                  new SpeechSynthesisUtterance(
                    response.value.match(/ Áâõ/)
                      ? response.value.replace(/üêÆ/g, 'Áâõ')
                      : response.value.replace(/^[^ ]*/, '')
                  )
                );
              }
            }
          );

          return {
            question,
            answer,
            correct,
            response,
            reAnswer,
            setOperator,
            getQuestion,
            judge,
            next,
            showAnswer,
            answered,
            input,
            histories,
            calc,
            reset,
            totalTime,
            duration,
            average,
            operations,
            OPERATORS,
            isActiveAndOnly,
          };
        },
      };

      createApp(app).use(ArcoVue).use(ArcoVueIcon).mount('#app');
    </script>
  </body>
</html>
